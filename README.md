# 人脸识别考勤系统 (Face Recognition Attendance System)

## 📖 项目简介
本项目是一个基于桌面端的智能化考勤解决方案，集成了计算机视觉、深度学习和数据库技术。系统采用 Python 开发，前端基于 PyQt6 构建现代化图形界面，后端集成 InsightFace 识别框架与 Silent-Face-Anti-Spoofing 活体检测技术，旨在提供非接触式、高效且安全的考勤管理体验。

## ✨ 核心功能
*   **📷 实时监控与人脸检测**：调用摄像头实时捕获并定位人脸，支持多目标检测。
*   **🛡️ 静默活体检测 (Anti-Spoofing)**：有效防御照片、视频翻拍、屏幕翻拍等攻击手段，支持界面一键开关。
*   **🔍 人脸识别与身份核验**：基于 InsightFace 提取特征向量比对（1:N），毫秒级识别注册用户。
*   **⏱️ 智能考勤会话管理**：自定义考勤会话（Session），自动根据时间阈值判定"迟到"或"正常"状态，防止重复刷屏签到。
*   **🎬 可视化视频导入**：支持导入本地视频文件进行离线考勤分析，实时预览处理进度，并支持导出 Excel 统计报表。
*   **👤 人员档案管理**：支持以本地照片或摄像头实时抓拍方式录入人员，内置图像质量检测。
*   **📊 数据持久化与导出**：使用 SQLite 数据库存储记录，支持考勤历史查询与导出。

## 🛠️ 技术架构
*   **UI 框架**: PyQt6 (采用 Model-View-Controller 模式，多线程渲染保证界面流畅)
*   **人脸分析**: InsightFace (Buffalo_l 模型: Detection + Recognition)
*   **活体检测**: MiniFASNet (V1SE + V2 双模型融合策略)
*   **推理引擎**: ONNX Runtime (支持 CUDA GPU 加速，自动回退至 CPU)
*   **数据库**: SQLite + SQLAlchemy ORM
*   **数据分析**: Pandas (用于 Excel 报表生成)

## 🚀 快速开始

### 1. 环境准备
确保您的计算机已安装 Python 3.8+。推荐使用 Anaconda 创建虚拟环境。

```bash
conda create -n face-rec python=3.9
conda activate face-rec
```

### 2. 安装依赖
根据您的硬件配置选择依赖文件：

```bash
# 如果使用 NVIDIA 显卡 (强烈推荐，需安装 CUDA 11.x)
pip install -r backend/requirements.gpu.txt

#Or for CPU only environment
pip install -r backend/requirements.cpu.txt
```

### 3. 启动应用
在项目根目录下运行启动脚本：

```bash
python desktop/main.py
```

## 📦 模型下载
本项目使用 **Git LFS** 托管大型模型。
Clone 项目时，Git LFS 会自动下载以下模型文件到 `models/buffalo_l/`：
- `w600k_r50.onnx`
- `1k3d68.onnx`

如果您下载的代码中这些文件只有 1KB 大小，请运行：
```bash
git lfs pull
```

## 📖 使用指南

### 1. 界面概览
*   **左侧区**: 实时监控画面、识别控制按钮（开始/停止/截图）、活体检测开关。
*   **右侧区**: 功能导航栏（考勤签到、人员管理、设置）。

### 2. 人员录入 (首次使用必做)
1.  点击右侧 **"👤 人员管理"** 标签。
2.  输入 **姓名** 与 **学号/工号**。
3.  点击 **"📷 拍照录入"** (需开启摄像头) 或 **"📂 选择照片"** (本地上传)。
4.  系统自动检测质量通过后，点击 **"💾 保存/注册"**。

### 3. 开启考勤
1.  切换至 **"📋 考勤签到"** 标签。
2.  (可选) 输入课程或会议名称作为会话名。
3.  点击左侧下方蓝色按钮 **"▶ 开始识别"**。
4.  **状态反馈**:
    *   🟩 **绿色框**: 认证成功，显示姓名与置信度。
    *   🟥 **红色框**: 
        *   `Unknown`: 未注册人员。
        *   `Fake Face`: 检测到非活体攻击 (如照片/手机)。

### 4. 视频导入与分析
1.  点击顶部工具栏的 **"导入视频"** 图标。
2.  选择本地 `.mp4` 或 `.avi` 视频文件。
3.  在弹出的对话框中，系统将自动分析视频中的人脸并进行考勤。
4.  完成后点击卡片下方的 **"导出 Excel"** 按钮保存记录。

## ❓ 常见问题 (FAQ)

**Q: 识别一直显示 "Unknown"？**
A: 请确认该人员已注册。如环境光线较暗或人脸角度过大，请尝试调整位置或在设置中降低识别阈值。

**Q: "Fake Face" 误报严重？**
A: 强逆光、面部反光或画质模糊可能干扰活体检测。如果误报影响使用，可尝试关闭界面的 "🛡️ 活体检测" 开关。

**Q: 程序运行卡顿、FPS 低？**
A: 
1. 确认是否已安装 GPU 版本依赖并正确配置 CUDA。
2. 在 "⚙️ 设置" 中降低 "检测分辨率" (如设为 320x320)。
3. 减少 "最大检测人数" 限制。

## 📂 目录结构
```text
backend/
├── app/             # 核心业务逻辑 (Face, DB, Services)
├── requirements.txt # 依赖列表
data/
├── db/              # SQLite 数据库文件
├── faces/           # 截取的人脸图像
models/              # ONNX 模型文件
desktop/             # PyQt6 图形界面源码
```
